<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SISTEMA NTI 2026 | KELVIN MASTER</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- VARI√ÅVEIS DE DESIGN --- */
        :root {
            --azul-deep: #001a33;
            --azul-sky: #00adef;
            --neon-green: #00ff9d;
            --danger: #ff4757;
            --warning: #ffb102;
            --glass: rgba(0, 0, 0, 0.85);
        }

        /* --- RESET E BASE --- */
        * { box-sizing: border-box; font-family: 'Poppins', sans-serif; transition: 0.3s ease; }
        
        body { 
            margin: 0; 
            background: #000 url('https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=2072') no-repeat center center fixed; 
            background-size: cover; 
            min-height: 100vh; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            overflow: hidden;
        }

        /* --- CONTAINERS ORGANIZADOS --- */
        .container-master { 
            width: 95%; 
            max-width: 600px; 
            background: var(--glass); 
            backdrop-filter: blur(20px); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            border-radius: 30px; 
            padding: 30px; 
            box-shadow: 0 25px 50px rgba(0,0,0,0.8);
            position: relative;
        }

        .hidden { display: none !important; }

        /* --- INPUTS E BOT√ïES ESTILIZADOS --- */
        .campo-input {
            width: 100%; padding: 14px; margin-bottom: 12px;
            border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.9); font-weight: 600; color: #111;
        }

        .btn-universal {
            width: 100%; height: 50px; border-radius: 15px; border: none;
            font-weight: 700; text-transform: uppercase; cursor: pointer;
            margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 10px;
        }

        .btn-primary { background: linear-gradient(135deg, #004a99, var(--azul-sky)); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--azul-sky); color: var(--azul-sky); }
        .btn-danger { background: var(--danger); color: white; }

        /* --- CARDS DE MONITORAMENTO --- */
        .card-log {
            background: rgba(255,255,255,0.05); padding: 12px; border-radius: 12px;
            margin-bottom: 10px; border-left: 4px solid var(--azul-sky); font-size: 13px;
        }

        /* --- SISTEMA DE AVISOS --- */
        #alert-box {
            position: fixed; top: 20px; width: 90%; max-width: 450px;
            padding: 20px; border-radius: 15px; z-index: 10001; text-align: center; font-weight: bold;
        }

        /* --- TELA DE CONGELAMENTO --- */
        #freeze-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.98); z-index: 10000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
    </style>
</head>
<body onload="app.init()">

    <div id="freeze-overlay" class="hidden">
        <h1 style="color:var(--danger); font-size:80px;">‚ö†Ô∏è</h1>
        <h2 id="freeze-msg">SISTEMA BLOQUEADO PELO TI</h2>
        <p>Aguarde a libera√ß√£o do Administrador Kelvin.</p>
    </div>

    <div id="alert-box" class="hidden"></div>

    <div class="container-master">
        <div id="relogio" style="text-align:right; font-size:12px; color:var(--azul-sky); font-weight:700;"></div>

        <div id="section-home">
            <h2 style="text-align:center; letter-spacing:2px;">NTI MASTER 2026</h2>
            <p style="text-align:center; color:#888; font-size:12px;">Selecione seu Portal de Acesso</p>
            <button class="btn-universal btn-primary" onclick="app.setPortal('PROFESSOR')">üë®‚Äçüè´ Portal Professor</button>
            <button class="btn-universal btn-primary" style="background:#333" onclick="app.setPortal('GEST√ÉO')">üëî Portal Gest√£o</button>
            <button class="btn-universal btn-primary" style="background:#222" onclick="app.setPortal('SECRETARIA')">üìù Portal Secretaria</button>
            <hr style="border:0; border-top:1px solid #333; margin:20px 0;">
            <button class="btn-universal btn-outline" style="border-color:var(--danger); color:var(--danger)" onclick="app.nav('ti-auth')">üõ°Ô∏è ACESSO TI MASTER</button>
        </div>

        <div id="section-auth" class="hidden">
            <h3 id="auth-title">LOGIN</h3>
            <input type="number" id="field-id" class="campo-input" placeholder="Digite seu Prontu√°rio" oninput="app.checkUser(this.value)">
            
            <div id="form-new-user" class="hidden">
                <input type="text" id="field-nome" class="campo-input" placeholder="Nome Completo">
                <input type="text" id="field-materia" class="campo-input hidden" placeholder="Disciplina / Mat√©ria">
            </div>

            <input type="password" id="field-pass" class="campo-input" placeholder="Senha de Acesso">
            <button class="btn-universal btn-primary" id="btn-login-main" onclick="app.handleAuth()">Acessar Sistema</button>
            <button class="btn-universal" style="background:none; color:#555;" onclick="location.reload()">Voltar ao In√≠cio</button>
        </div>

        <div id="section-portal" class="hidden">
            <h3 id="user-welcome">Bem-vindo</h3>
            
            <div id="user-actions">
                <button class="btn-universal btn-primary" onclick="app.modal('reserva')">üìÖ Nova Reserva de Equipamento</button>
                <button class="btn-universal" style="background:var(--warning); color:black;" onclick="app.modal('chamado')">üÜò Abrir Chamado TI</button>
            </div>

            <div style="margin-top:20px;">
                <p style="font-size:12px; font-weight:700; color:var(--azul-sky)">üìä MONITOR DE RESERVAS (TEMPO REAL):</p>
                <div id="realtime-reservas" style="max-height:250px; overflow-y:auto; padding-right:5px;"></div>
            </div>

            <button class="btn-universal" style="background:none; border:1px solid #333; color:#555; margin-top:20px;" onclick="location.reload()">Sair do Sistema</button>
        </div>

        <div id="section-ti-painel" class="hidden">
            <h3 style="color:var(--danger)">üõ°Ô∏è PAINEL MASTER KELVIN</h3>
            
            <div class="card-log" style="background:rgba(255,255,255,0.1)">
                <strong>üì¢ COMANDOS DE REDE:</strong>
                <div style="display:flex; gap:5px; margin-top:10px;">
                    <button onclick="app.broadcast('urgente')" style="background:red; color:white; border:none; flex:1; padding:8px; border-radius:8px; font-size:10px; font-weight:bold;">URGENTE</button>
                    <button onclick="app.broadcast('medio')" style="background:orange; border:none; flex:1; padding:8px; border-radius:8px; font-size:10px; font-weight:bold;">M√âDIO</button>
                    <button onclick="app.broadcast('basico')" style="background:var(--azul-sky); border:none; flex:1; padding:8px; border-radius:8px; font-size:10px; font-weight:bold;">B√ÅSICO</button>
                </div>
            </div>

            <div id="ti-users-list" style="max-height:200px; overflow-y:auto; margin-bottom:15px;"></div>
            <div id="ti-chamados-list" style="max-height:200px; overflow-y:auto; background:rgba(0,0,0,0.4); padding:10px; border-radius:15px;">
                <p style="font-size:10px; color:var(--warning)">üí¨ √öLTIMOS CHAMADOS:</p>
            </div>
            
            <button class="btn-universal btn-outline" onclick="location.reload()" style="margin-top:15px;">Fechar Torre</button>
        </div>

        <div id="section-ti-auth" class="hidden">
            <h3>CHAVE MESTRA</h3>
            <input type="password" id="ti-password" class="campo-input" placeholder="Senha do Administrador">
            <button class="btn-universal btn-danger" onclick="app.accessTI()">Desbloquear Painel</button>
        </div>

    </div>

<script>
    /* --- M√ìDULO FIREBASE --- */
    const firebaseConfig = { databaseURL: "https://escala-chacara-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    /* --- MOTOR DO SISTEMA --- */
    const app = {
        currentRole: '',
        currentUser: null,
        userExists: false,

        init() {
            setInterval(() => { document.getElementById('relogio').innerText = new Date().toLocaleString(); }, 1000);
            this.listenToNetwork();
            this.listenToReservas();
        },

        nav(section) {
            document.querySelectorAll('.container-master > div').forEach(div => { if(div.id !== 'relogio') div.classList.add('hidden'); });
            document.getElementById('section-' + section).classList.remove('hidden');
        },

        setPortal(role) {
            this.currentRole = role;
            document.getElementById('auth-title').innerText = "Acesso " + role;
            this.nav('auth');
        },

        async checkUser(id) {
            if(id.length < 3) return;
            const snap = await db.ref('usuarios/' + id).once('value');
            this.userExists = snap.exists();

            document.getElementById('form-new-user').classList.toggle('hidden', this.userExists);
            document.getElementById('field-materia').classList.toggle('hidden', this.currentRole !== 'PROFESSOR' || this.userExists);
            document.getElementById('btn-login-main').innerText = this.userExists ? "Confirmar Entrada" : "Cadastrar e Entrar";
        },

        async handleAuth() {
            const id = document.getElementById('field-id').value;
            const pass = document.getElementById('field-pass').value;

            if(this.userExists) {
                const snap = await db.ref('usuarios/' + id).once('value');
                const u = snap.val();
                if(u.pass !== pass) return alert("Senha Incorreta!");
                if(u.blocked) return this.freeze("Acesso bloqueado por seguran√ßa.");
                this.currentUser = u;
                this.openPortal();
            } else {
                const nome = document.getElementById('field-nome').value;
                const materia = document.getElementById('field-materia').value || 'N/A';
                if(!nome || !pass) return alert("Preencha todos os dados!");
                
                const newUser = { id, pass, nome, materia, role: this.currentRole, blocked: false };
                await db.ref('usuarios/' + id).set(newUser);
                this.currentUser = newUser;
                this.openPortal();
            }
        },

        openPortal() {
            document.getElementById('user-welcome').innerText = "Ol√°, " + this.currentUser.nome;
            this.nav('portal');
            if(this.currentUser.role === 'GEST√ÉO') document.getElementById('user-actions').classList.add('hidden');
        },

        // --- M√ìDULO DE RESERVAS ---
        modal(type) {
            if(type === 'reserva') {
                const item = prompt("Qual equipamento voc√™ deseja reservar?");
                if(item) {
                    db.ref('reservas').push({
                        item, user: this.currentUser.nome, role: this.currentUser.role,
                        time: new Date().toLocaleTimeString(), status: 'EM USO'
                    });
                }
            } else if(type === 'chamado') {
                const desc = prompt("Descreva o problema para o TI:");
                if(desc) db.ref('chamados').push({ user: this.currentUser.nome, desc, timestamp: Date.now() });
            }
        },

        listenToReservas() {
            db.ref('reservas').on('value', snap => {
                const container = document.getElementById('realtime-reservas');
                container.innerHTML = "";
                snap.forEach(res => {
                    const r = res.val();
                    const isEntregue = r.status === 'ENTREGUE';
                    container.innerHTML += `
                        <div class="card-log" style="border-left-color: ${isEntregue ? 'var(--neon-green)' : 'var(--warning)'}">
                            <span style="float:right; font-size:10px; background:#333; padding:2px 5px; border-radius:5px;">${r.status}</span>
                            <b>${r.item}</b><br>
                            <small>${r.user} (${r.role}) - ${r.time}</small>
                            ${!isEntregue && this.currentUser && this.currentUser.role !== 'GEST√ÉO' ? 
                            `<br><button onclick="app.returnItem('${res.key}')" style="font-size:10px; margin-top:5px; cursor:pointer;">Marcar como Entregue</button>` : ''}
                        </div>`;
                });
            });
        },

        returnItem(key) { db.ref('reservas/' + key).update({ status: 'ENTREGUE' }); },

        // --- M√ìDULO TI MASTER ---
        accessTI() {
            if(document.getElementById('ti-password').value === 'nti2026') {
                this.nav('ti-painel');
                this.loadTIMaster();
            } else { alert("Chave Incorreta!"); }
        },

        loadTIMaster() {
            // Usu√°rios
            db.ref('usuarios').on('value', snap => {
                const list = document.getElementById('ti-users-list');
                list.innerHTML = "<p style='font-size:10px; color:var(--azul-sky)'>GERENCIAR USU√ÅRIOS:</p>";
                snap.forEach(u => {
                    const d = u.val();
                    list.innerHTML += `
                        <div class="card-log" style="border-left-color: ${d.blocked ? 'red' : 'var(--neon-green)'}">
                            ${d.nome} (${d.role})<br>
                            <button onclick="app.tiControl('${d.id}', 'block', ${d.blocked})" style="font-size:9px">${d.blocked ? 'Ativar' : 'Bloquear'}</button>
                            <button onclick="app.tiControl('${d.id}', 'reset')" style="font-size:9px">Reset Senha</button>
                        </div>`;
                });
            });
            // Chamados
            db.ref('chamados').on('value', snap => {
                const list = document.getElementById('ti-chamados-list');
                list.innerHTML = "<p style='font-size:10px; color:var(--warning)'>üí¨ √öLTIMOS CHAMADOS:</p>";
                snap.forEach(c => {
                    const d = c.val();
                    list.innerHTML += `<div style="font-size:11px; padding:5px; border-bottom:1px solid #222"><b>${d.user}:</b> ${d.desc}</div>`;
                });
            });
        },

        tiControl(id, action, state) {
            if(action === 'block') db.ref('usuarios/' + id).update({ blocked: !state });
            if(action === 'reset') {
                const nova = prompt("Nova senha:");
                if(nova) db.ref('usuarios/' + id).update({ pass: nova });
            }
        },

        broadcast(type) {
            const msg = prompt("Mensagem do Alerta:");
            if(msg) db.ref('config/alert').set({ type, msg, ts: Date.now() });
        },

        listenToNetwork() {
            db.ref('config/alert').on('value', snap => {
                const a = snap.val();
                if(!a) return;
                const box = document.getElementById('alert-box');
                box.innerText = a.msg;
                box.className = a.type;
                
                if(a.type === 'urgente') {
                    this.freeze(a.msg);
                } else {
                    box.classList.remove('hidden');
                    if(a.type === 'medio') { box.style.background = "var(--warning)"; box.style.color = "black"; }
                    if(a.type === 'basico') { box.style.background = "var(--azul-sky)"; box.style.color = "white"; }
                    setTimeout(() => box.classList.add('hidden'), 5000);
                }
            });
        },

        freeze(msg) {
            document.getElementById('freeze-msg').innerText = msg;
            document.getElementById('freeze-overlay').classList.remove('hidden');
        }
    }
</script>
</body>
</html>
