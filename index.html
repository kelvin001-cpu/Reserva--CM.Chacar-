<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA NTi - KELVIN MASTER</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #000 url('https://images.unsplash.com/photo-1510511459019-5dda7724fd87?q=80&w=2070&auto=format&fit=crop') no-repeat center center fixed;
            background-size: cover;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        .container {
            background: rgba(0, 0, 0, 0.8);
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 450px;
            text-align: center;
            border: 2px solid #00adef;
        }
        input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border-radius: 5px;
            border: none;
            font-size: 16px;
        }
        button {
            width: 100%;
            padding: 12px;
            background: #00adef;
            color: white;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }
        .btn-ti { background: #ff4757; }
        .hidden { display: none; }
        .card-user {
            background: #222;
            padding: 10px;
            margin-top: 10px;
            border-radius: 5px;
            text-align: left;
            border-left: 5px solid #00adef;
        }
        .ctrl-btns { margin-top: 10px; }
        .ctrl-btns button { width: auto; padding: 5px 10px; font-size: 12px; margin-right: 5px; }
    </style>
</head>
<body onload="app.init()">

<div class="container">
    <div id="relogio" style="margin-bottom: 15px; font-weight: bold; color: #00adef;"></div>

    <div id="tela-inicio">
        <h1>SISTEMA NTi 2026</h1>
        <button onclick="app.abrir('PROF')">PORTAL PROFESSOR</button>
        <button onclick="app.abrir('GESTOR')" style="background: #555;">PORTAL GESTÃO</button>
        <button class="btn-ti" onclick="app.abrir('TI')">TI MASTER KELVIN</button>
    </div>

    <div id="tela-auth" class="hidden">
        <h2 id="titulo-auth">ACESSO</h2>
        <input type="number" id="id-pront" placeholder="Prontuário" oninput="app.checarID(this.value)">
        
        <div id="cadastro" class="hidden">
            <input type="text" id="id-nome" placeholder="Nome Completo">
            <input type="text" id="id-materia" class="hidden" placeholder="Matéria">
        </div>

        <input type="password" id="id-senha" placeholder="Senha">
        <button id="btn-entrar" onclick="app.entrar()">ENTRAR NO SISTEMA</button>
        <button onclick="location.reload()" style="background:none;">Voltar</button>
    </div>

    <div id="tela-master" class="hidden">
        <h2>PAINEL TI MASTER</h2>
        <div id="lista-usuarios" style="max-height: 300px; overflow-y: auto;"></div>
        <button onclick="location.reload()" style="background:#555;">SAIR DO PAINEL</button>
    </div>

    <div id="tela-menu" class="hidden">
        <h2 id="msg-bem-vindo">Olá</h2>
        <button onclick="alert('Sistema de Reservas em breve')">RESERVAR EQUIPAMENTO</button>
        <button onclick="location.reload()" style="background:none;">SAIR</button>
    </div>
</div>

<script>
    // CONFIGURAÇÃO FIREBASE
    const firebaseConfig = {
        apiKey: "AIzaSyBoGfDKz-nBwKvczzGpxg-fHJYdVykcBUQ",
        databaseURL: "https://escala-chacara-default-rtdb.firebaseio.com",
        projectId: "escala-chacara",
        appId: "1:741259231706:web:27e2b60be100e6a34180e3"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const app = {
        cargo: '', existe: false,

        init() {
            setInterval(() => { document.getElementById('relogio').innerText = new Date().toLocaleString(); }, 1000);
        },

        abrir(tipo) {
            this.cargo = tipo;
            if(tipo === 'TI') {
                const p = prompt("SENHA MESTRE:");
                if(p === 'nti2026') this.carregarTI();
                else alert("Negado");
                return;
            }
            document.getElementById('titulo-auth').innerText = "PORTAL " + tipo;
            this.irPara('auth');
        },

        irPara(tela) {
            document.querySelectorAll('.container > div').forEach(d => { if(d.id !== 'relogio') d.classList.add('hidden'); });
            document.getElementById('tela-' + tela).classList.remove('hidden');
        },

        async checarID(p) {
            if(p.length < 3) return;
            const snap = await db.ref('usuarios/' + p).once('value');
            this.existe = snap.exists();
            document.getElementById('cadastro').classList.toggle('hidden', this.existe);
            if(!this.existe && this.cargo === 'PROF') {
                document.getElementById('id-materia').classList.remove('hidden');
            } else {
                document.getElementById('id-materia').classList.add('hidden');
            }
        },

        async entrar() {
            const p = document.getElementById('id-pront').value;
            const s = document.getElementById('id-senha').value;

            if(this.existe) {
                const snap = await db.ref('usuarios/' + p).once('value');
                const user = snap.val();
                if(user.senha !== s) return alert("Senha Incorreta");
                if(user.status === 'CONGELADO') return alert("ACESSO BLOQUEADO PELO TI");
                this.logado(user.nome);
            } else {
                const n = document.getElementById('id-nome').value;
                const m = document.getElementById('id-materia').value || "N/A";
                if(!n || !s) return alert("Preencha tudo");
                const novo = { pront: p, nome: n, senha: s, cargo: this.cargo, materia: m, status: 'ATIVO' };
                await db.ref('usuarios/' + p).set(novo);
                this.logado(n);
            }
        },

        logado(nome) {
            document.getElementById('msg-bem-vindo').innerText = "Bem-vindo, " + nome;
            this.irPara('menu');
        },

        carregarTI() {
            this.irPara('master');
            const lista = document.getElementById('lista-usuarios');
            db.ref('usuarios').on('value', snap => {
                lista.innerHTML = "";
                snap.forEach(u => {
                    const d = u.val();
                    lista.innerHTML += `
                        <div class="card-user" style="border-left-color: ${d.status === 'CONGELADO' ? 'red' : '#00adef'}">
                            <b>${d.nome}</b> (${d.cargo})<br>
                            ID: ${d.pront} | Senha: ${d.senha}<br>
                            <div class="ctrl-btns">
                                <button onclick="app.mudarStatus('${d.pront}', '${d.status}')">${d.status === 'ATIVO' ? 'CONGELAR' : 'ATIVAR'}</button>
                                <button onclick="app.deletar('${d.pront}')" style="background:red">APAGAR</button>
                            </div>
                        </div>`;
                });
            });
        },

        mudarStatus(id, s) { db.ref('usuarios/'+id).update({status: s === 'ATIVO' ? 'CONGELADO' : 'ATIVO'}); },
        deletar(id) { if(confirm("Apagar?")) db.ref('usuarios/'+id).remove(); }
    };
</script>
</body>
</html>
