<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA NTi 2026 - KELVIN MASTER</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        :root { --azul: #004a99; --perigo: #ff4757; --neon: #00ff9d; }
        body { margin: 0; font-family: 'Poppins', sans-serif; background: #000b1a; color: white; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .caixa { width: 90%; max-width: 500px; background: rgba(255,255,255,0.05); padding: 30px; border-radius: 20px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); text-align: center; }
        .hidden { display: none !important; }
        input, select { width: 100%; padding: 12px; margin: 10px 0; border-radius: 10px; border: none; outline: none; font-weight: bold; }
        button { width: 100%; padding: 15px; border-radius: 10px; border: none; background: var(--azul); color: white; font-weight: bold; cursor: pointer; text-transform: uppercase; margin-top: 10px; }
        .card { background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; margin-top: 10px; text-align: left; border-left: 4px solid var(--neon); }
        .btn-ti { padding: 5px; font-size: 10px; margin: 2px; cursor: pointer; }
    </style>
</head>
<body onload="app.init()">

<div class="caixa">
    <div id="relogio" style="margin-bottom: 20px; color: var(--neon);"></div>

    <div id="tela-inicio">
        <h2>PORTAL NTi 2026</h2>
        <button onclick="app.abrir('PROF')">Professor</button>
        <button style="background:#444" onclick="app.abrir('GESTOR')">Gestão</button>
        <button style="background:#222" onclick="app.abrir('SEC')">Secretaria</button>
        <button style="background:black; border: 1px solid red" onclick="app.irPara('ti-login')">ADMIN KELVIN</button>
    </div>

    <div id="tela-login" class="hidden">
        <h3 id="titulo-portal">ACESSO</h3>
        <input type="text" id="p-prontuario" placeholder="Prontuário" oninput="app.checar(this.value)">
        
        <div id="campos-novos" class="hidden">
            <input type="text" id="p-nome" placeholder="Nome Completo">
            <input type="text" id="p-materia" class="hidden" placeholder="Matéria">
        </div>

        <input type="password" id="p-senha" placeholder="Senha">
        <button onclick="app.entrar()">CONECTAR</button>
        <button style="background:none; color:gray" onclick="app.irPara('inicio')">VOLTAR</button>
    </div>

    <div id="tela-ti-login" class="hidden">
        <h3>KELVIN MASTER</h3>
        <input type="password" id="ti-pass" placeholder="Senha Mestra">
        <button style="background:red" onclick="app.loginTI()">ENTRAR</button>
        <button style="background:none" onclick="app.irPara('inicio')">VOLTAR</button>
    </div>

    <div id="tela-menu" class="hidden">
        <h2 id="msg-user">Olá</h2>
        <div id="bloco-ti" class="hidden">
            <button style="background:red" onclick="app.irPara('ti-controle')">GERENCIAR USUÁRIOS</button>
        </div>
        <button onclick="alert('Reserva em breve...')">FAZER RESERVA</button>
        <button style="background:none" onclick="app.logout()">SAIR</button>
    </div>

    <div id="tela-ti-controle" class="hidden">
        <h3>CONTROLE DE ACESSO</h3>
        <div id="lista-users" style="max-height: 300px; overflow-y: auto;"></div>
        <button onclick="app.irPara('menu')">VOLTAR</button>
    </div>
</div>

<script>
    // VERIFIQUE SE ESTAS CHAVES SÃO AS DO SEU FIREBASE ATUAL
    const firebaseConfig = {
        apiKey: "AIzaSyBoGfDKz-nBwKvczzGpxg-fHJYdVykcBUQ",
        databaseURL: "https://escala-chacara-default-rtdb.firebaseio.com",
        projectId: "escala-chacara",
        appId: "1:741259231706:web:27e2b60be100e6a34180e3"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const app = {
        user: null, cargo: '', existe: false,

        init() {
            const cache = localStorage.getItem('user_kelvin');
            if(cache) { this.user = JSON.parse(cache); this.sucesso(); }
            else { this.irPara('inicio'); }
            setInterval(() => { document.getElementById('relogio').innerText = new Date().toLocaleString(); }, 1000);
        },

        irPara(t) {
            document.querySelectorAll('.caixa > div').forEach(d => { if(d.id !== 'relogio') d.classList.add('hidden'); });
            document.getElementById('tela-' + t).classList.remove('hidden');
            if(t === 'ti-controle') this.carregarUsers();
        },

        abrir(c) {
            this.cargo = c;
            document.getElementById('titulo-portal').innerText = "PORTAL " + c;
            this.irPara('login');
        },

        async checar(p) {
            if(p.length < 3) return;
            const snap = await db.ref('usuarios/' + p).once('value');
            this.existe = snap.exists();
            document.getElementById('campos-novos').classList.toggle('hidden', this.existe);
            if(!this.existe && this.cargo === 'PROF') {
                document.getElementById('p-materia').classList.remove('hidden');
            } else {
                document.getElementById('p-materia').classList.add('hidden');
            }
        },

        async entrar() {
            const pront = document.getElementById('p-prontuario').value;
            const senha = document.getElementById('p-senha').value;

            if(this.existe) {
                const snap = await db.ref('usuarios/' + pront).once('value');
                const dados = snap.val();
                if(dados.senha !== senha) return alert("Senha Incorreta!");
                if(dados.status === 'CONGELADO') return alert("SUA CONTA FOI CONGELADA PELO TI!");
                this.user = dados;
            } else {
                const nome = document.getElementById('p-nome').value;
                const mat = document.getElementById('p-materia').value || "N/A";
                if(!nome || !senha) return alert("Preencha tudo!");
                this.user = { pront, nome, senha, cargo: this.cargo, materia: mat, status: 'ATIVO' };
                await db.ref('usuarios/' + pront).set(this.user);
            }
            localStorage.setItem('user_kelvin', JSON.stringify(this.user));
            this.sucesso();
        },

        loginTI() {
            if(document.getElementById('ti-pass').value === 'nti2026') {
                this.user = { nome: 'TÉCNICO KELVIN', cargo: 'TI' };
                this.sucesso();
            } else { alert("Acesso Negado"); }
        },

        sucesso() {
            document.getElementById('msg-user').innerText = "Olá, " + this.user.nome;
            document.getElementById('bloco-ti').classList.toggle('hidden', this.user.cargo !== 'TI');
            this.irPara('menu');
        },

        carregarUsers() {
            const lista = document.getElementById('lista-users');
            db.ref('usuarios').on('value', snap => {
                lista.innerHTML = "";
                snap.forEach(u => {
                    const d = u.val();
                    lista.innerHTML += `
                        <div class="card" style="border-color:${d.status === 'CONGELADO' ? 'red' : 'green'}">
                            <b>${d.nome}</b> (${d.cargo})<br>
                            Senha: ${d.senha} | Status: ${d.status}<br>
                            <button class="btn-ti" onclick="app.mudarSenha('${d.pront}')">SENHA</button>
                            <button class="btn-ti" onclick="app.mudarStatus('${d.pront}', '${d.status}')">CONGELAR/ATIVAR</button>
                            <button class="btn-ti" style="color:red" onclick="app.deletar('${d.pront}')">APAGAR</button>
                        </div>`;
                });
            });
        },

        mudarSenha(p) { 
            const n = prompt("Nova senha:"); 
            if(n) db.ref('usuarios/'+p).update({ senha: n }); 
        },

        mudarStatus(p, s) { 
            db.ref('usuarios/'+p).update({ status: s === 'ATIVO' ? 'CONGELADO' : 'ATIVO' }); 
        },

        deletar(p) { 
            if(confirm("Apagar conta?")) db.ref('usuarios/'+p).remove(); 
        },

        logout() { localStorage.clear(); location.reload(); }
    };
</script>
</body>
</html>
